// Tower Collapse Tests
// Tests for collapsing towers of interpreters semantics
//
// The key insight: at level 0, we evaluate directly.
// At level > 0, we generate code.
// This allows nested interpreters to collapse into single-pass compilation.

// =============================================================================
// Test 1: Basic lift/run cycle
// =============================================================================
// (run (lift 42)) should return 42
// - lift creates staged code at level 1
// - run executes the staged code back at level 0

@test_lift_run =
  @omni_run(#Run{#Lift{#Lit{42}}})
  // Expected: #Cst{42}

// =============================================================================
// Test 2: Lift arithmetic - generates code
// =============================================================================
// (lift (+ 1 2)) at level 1 should generate #Add{#Lit{1}, #Lit{2}}
// Then (run ...) should execute it to get 3

@test_lift_add =
  @omni_run(#Run{#Lift{#Add{#Lit{1}, #Lit{2}}}})
  // Expected: #Cst{3}

// =============================================================================
// Test 3: Stage-polymorphic eval at level 0
// =============================================================================
// At level 0, evaluates directly

@test_sp_level0 =
  @omni_run_sp(#Add{#Lit{10}, #Lit{20}})
  // Expected: #Cst{30}

// =============================================================================
// Test 4: Stage-polymorphic eval at level 1
// =============================================================================
// At level 1, generates code instead of evaluating

@test_sp_level1 =
  @omni_run_at_level(#Cst{1})(#Add{#Lit{5}, #Lit{7}})
  // Expected: #Add{#Lit{5}, #Lit{7}} (code, not #Cst{12})

// =============================================================================
// Test 5: EM (Eval-Meta) - jump to parent level
// =============================================================================
// Inside a lifted context, EM evaluates at the parent (lower) level

@test_em_basic =
  // Start at level 0
  // lift moves to level 1
  // EM inside lift evaluates at level 0 (parent)
  // So (EM (+ 1 2)) returns #Cst{3} at level 0
  // Then that #Cst{3} is the result at level 1
  @omni_run(#Run{#Lift{#EM{#Add{#Lit{1}, #Lit{2}}}}})
  // Expected: #Cst{3}

// =============================================================================
// Test 6: Nested lift/run (tower of 2 levels)
// =============================================================================
// (run (run (lift (lift 99))))
// - outer lift: level 0 -> 1
// - inner lift: level 1 -> 2
// - inner run: level 2 -> 1 (generates code)
// - outer run: level 1 -> 0 (executes code)

@test_nested_lift_run =
  @omni_run(#Run{#Run{#Lift{#Lift{#Lit{99}}}}})
  // Expected: #Cst{99}

// =============================================================================
// Test 7: Reflect - value to code
// =============================================================================
// (reflect 42) turns the value 42 into code #Lit{42}

@test_reflect =
  @omni_run(#Refl{#Lit{42}})
  // Expected: #Lit{42}

// =============================================================================
// Test 8: Reify - code to value
// =============================================================================
// (reify (quote (+ 1 2))) evaluates the quoted code

@test_reify =
  @omni_run(#Reif{#Add{#Lit{10}, #Lit{5}}})
  // Expected: #Cst{15}

// =============================================================================
// Test 9: Meta-level query
// =============================================================================
// (meta-level) returns the current level number

@test_meta_level =
  @omni_run(#MLvl)
  // Expected: #Cst{0}

@test_meta_level_lifted =
  @omni_run(#Run{#Lift{#MLvl}})
  // Expected: #Cst{1} (inside lift, level is 1)

// =============================================================================
// Test 10: Partial evaluation via staging
// =============================================================================
// Known values should be computed, unknown should remain symbolic
// This is the key to tower collapse - compile-time evaluation

@test_partial_eval =
  // At level 1, (+ 3 4) with known operands should reduce to 7
  // But this depends on the partial evaluator in @sp_add
  @omni_run_at_level(#Cst{1})(#Add{#Lit{3}, #Lit{4}})
  // Expected: #Add{#Lit{3}, #Lit{4}} (code)
  // Note: Full partial evaluation would give #Lit{7}

// =============================================================================
// Test 11: Stage-polymorphic conditional
// =============================================================================
// At level 0, branches based on condition
// At level 1 with known condition, can still branch (partial eval)

@test_sp_if_level0 =
  @omni_run_sp(#If{#Lit{1}, #Lit{100}, #Lit{200}})
  // Expected: #Cst{100} (condition is truthy)

@test_sp_if_level0_false =
  @omni_run_sp(#If{#Lit{0}, #Lit{100}, #Lit{200}})
  // Expected: #Cst{200} (condition is falsy)

// =============================================================================
// Test 12: Self-interpretation tower
// =============================================================================
// The classic test: running an interpreter on itself
// With collapsing towers, this should not cause exponential slowdown
//
// This is a simplified version - full self-interpretation requires
// a complete meta-circular interpreter

@test_tower_identity =
  // Simple identity: run lifted identity function
  // (run (lift ((lambda [x] x) 42)))
  @omni_run(#Run{#Lift{#App{#Lam{#Var{0}}, #Lit{42}}}})
  // Expected: #Cst{42}

// =============================================================================
// Run all tests
// =============================================================================

@main =
  #Tests{
    @test_lift_run,
    @test_lift_add,
    @test_sp_level0,
    @test_sp_level1,
    @test_em_basic,
    @test_nested_lift_run,
    @test_reflect,
    @test_reify,
    @test_meta_level,
    @test_meta_level_lifted,
    @test_partial_eval,
    @test_sp_if_level0,
    @test_sp_if_level0_false,
    @test_tower_identity
  }
