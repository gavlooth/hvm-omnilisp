        -:    0:Source:../hvm4/clang/wnf/app_red_mat_ctr.c
        -:    0:Graph:main-cov-main.gcno
        -:    0:Data:main-cov-main.gcda
        -:    0:Runs:422
        -:    1:// ((f ~> λ{#K:h; m}) #K{a,b})
        -:    2:// --------------------------- APP-RED-MAT-CTR-MAT
        -:    3:// ((λa.λb.(f #K{a,b}) ~> h) a b)
    #####:    4:fn Term wnf_app_red_mat_ctr_match(Term f, Term mat, Term ctr) {
    #####:    5:  ITRS++;
    #####:    6:  u32  mat_loc = term_val(mat);
    #####:    7:  u32  ctr_loc = term_val(ctr);
    #####:    8:  u32  ctr_nam = term_ext(ctr);
    #####:    9:  u32  ctr_ari = term_tag(ctr) - C00;
    #####:   10:  Term h       = heap_read(mat_loc + 0);
        -:   11:
        -:   12:  // Build: (λa.λb.(f #K{a,b}) ~> h) applied to ctr args
        -:   13:  u64 lam_locs[16];
        -:   14:  Term vars[16];
    #####:   15:  for (u32 i = 0; i < ctr_ari; i++) {
    #####:   16:    lam_locs[i] = heap_alloc(1);
    #####:   17:    vars[i] = term_new(0, VAR, 0, lam_locs[i]);
        -:   18:  }
    #####:   19:  Term inner = term_new_app(f, term_new_ctr(ctr_nam, ctr_ari, vars));
        -:   20:
        -:   21:  // Wrap in lambdas from inside out
    #####:   22:  Term body = inner;
    #####:   23:  for (int32_t i = ctr_ari - 1; i >= 0; i--) {
    #####:   24:    heap_write(lam_locs[i], body);
    #####:   25:    body = term_new(0, LAM, 0, lam_locs[i]);
        -:   26:  }
        -:   27:
        -:   28:  // Create red: body ~> h
    #####:   29:  Term red_result = term_new_red(body, h);
        -:   30:
        -:   31:  // Apply to original ctr args
    #####:   32:  for (u32 i = 0; i < ctr_ari; i++) {
    #####:   33:    red_result = term_new_app(red_result, heap_read(ctr_loc + i));
        -:   34:  }
        -:   35:
    #####:   36:  return red_result;
        -:   37:}
        -:   38:
        -:   39:// ((f ~> λ{#K:h; m}) #L{a,b})
        -:   40:// --------------------------- APP-RED-MAT-CTR-MIS
        -:   41:// ((f ~> m) #L{a,b})
    #####:   42:fn Term wnf_app_red_mat_ctr_miss(Term f, Term mat, Term ctr) {
    #####:   43:  ITRS++;
    #####:   44:  u32  mat_loc = term_val(mat);
    #####:   45:  Term m       = heap_read(mat_loc + 1);
    #####:   46:  return term_new_app(term_new_red(f, m), ctr);
        -:   47:}
