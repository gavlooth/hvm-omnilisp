        -:    0:Source:../hvm4/clang/wnf/stack_init.c
        -:    0:Graph:main-cov-main.gcno
        -:    0:Data:main-cov-main.gcda
        -:    0:Runs:9
        -:    1:#include <sys/mman.h>
        -:    2:
        -:    3:#ifndef MAP_NORESERVE
        -:    4:#define MAP_NORESERVE 0
        -:    5:#endif
        -:    6:
       39:    7:fn void wnf_stack_init(void) {
       39:    8:  WnfBank *bank = WNF_BANK;
       39:    9:  if (bank->stack) {
       30:   10:    return;
        -:   11:  }
        -:   12:
        9:   13:  u64 bytes = WNF_CAP * sizeof(Term);
        9:   14:  int prot  = PROT_READ | PROT_WRITE;
        9:   15:  int flags = MAP_PRIVATE | MAP_ANONYMOUS | MAP_NORESERVE;
        9:   16:  Term *stack = (Term *)mmap(NULL, bytes, prot, flags, -1, 0);
        9:   17:  u8 stack_mmap = 1;
        -:   18:
        9:   19:  if (stack == MAP_FAILED) {
    #####:   20:    stack = (Term *)malloc(bytes);
    #####:   21:    stack_mmap = 0;
        -:   22:  }
        -:   23:
        9:   24:  if (!stack) {
    #####:   25:    fprintf(stderr, "wnf: stack allocation failed\n");
    #####:   26:    exit(1);
        -:   27:  }
        -:   28:
        9:   29:  bank->stack       = stack;
        9:   30:  bank->stack_bytes = bytes;
        9:   31:  bank->stack_mmap  = stack_mmap;
        9:   32:  bank->s_pos       = 1;
        -:   33:}
