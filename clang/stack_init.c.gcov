        -:    0:Source:../hvm4/clang/wnf/stack_init.c
        -:    0:Graph:main-cov-main.gcno
        -:    0:Data:main-cov-main.gcda
        -:    0:Runs:422
        -:    1:#include <sys/mman.h>
        -:    2:
        -:    3:#ifndef MAP_NORESERVE
        -:    4:#define MAP_NORESERVE 0
        -:    5:#endif
        -:    6:
  3584228:    7:fn void wnf_stack_init(void) {
  3584228:    8:  WnfBank *bank = WNF_BANK;
  3584228:    9:  if (bank->stack) {
  3583947:   10:    return;
        -:   11:  }
        -:   12:
      281:   13:  u64 bytes = WNF_CAP * sizeof(Term);
      281:   14:  int prot  = PROT_READ | PROT_WRITE;
      281:   15:  int flags = MAP_PRIVATE | MAP_ANONYMOUS | MAP_NORESERVE;
      281:   16:  Term *stack = (Term *)mmap(NULL, bytes, prot, flags, -1, 0);
      281:   17:  u8 stack_mmap = 1;
        -:   18:
      281:   19:  if (stack == MAP_FAILED) {
    #####:   20:    stack = (Term *)malloc(bytes);
    #####:   21:    stack_mmap = 0;
        -:   22:  }
        -:   23:
      281:   24:  if (!stack) {
    #####:   25:    fprintf(stderr, "wnf: stack allocation failed\n");
    #####:   26:    exit(1);
        -:   27:  }
        -:   28:
      281:   29:  bank->stack       = stack;
      281:   30:  bank->stack_bytes = bytes;
      281:   31:  bank->stack_mmap  = stack_mmap;
      281:   32:  bank->s_pos       = 1;
        -:   33:}
