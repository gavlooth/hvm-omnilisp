;; test_effects_reader.omni - Tests for Reader effect pattern
;; Reader effect provides access to an environment

;; TEST: ask for environment value
;; EXPECT: 42
(handle
  (perform ask-env nil)
  (ask-env [_ resume] (resume 42)))

;; TEST: multiple asks return same value - numeric sum
;; EXPECT: 126
(handle
  (+ (perform ask-config nil)
     (+ (perform ask-config nil)
        (perform ask-config nil)))
  (ask-config [_ resume] (resume 42)))

;; TEST: ask for specific key via different effects - numeric sum
;; EXPECT: 8180
(handle
  (+ (perform ask-host nil)
     (perform ask-port nil))
  (ask-host [_ resume] (resume 100))
  (ask-port [_ resume] (resume 8080)))

;; TEST: local override
;; EXPECT: 99
(handle
  (perform get-env nil)
  (get-env [_ resume] (resume 99)))

;; TEST: build sum from config
;; EXPECT: 543
(do
  (define build-sum [a] [b] (+ a b))
  (handle
    (build-sum (perform get-host nil) (perform get-port nil))
    (get-host [_ resume] (resume 100))
    (get-port [_ resume] (resume 443))))

;; TEST: ask with conditional
;; EXPECT: 0
(handle
  (let [val (perform ask-flag nil)]
    (if val 1 0))
  (ask-flag [_ resume] (resume false)))

;; EXPECT: true
(= (handle (perform val nil) (val [_ resume] (resume 42))) 42)
