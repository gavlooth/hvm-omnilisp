;; test_tcp_send_recv.lisp - Tests for TCP send/receive

;; Send data over socket
;; TEST: tcp-send returns bytes sent
;; EXPECT: 5
(with-mock-network :echo
  (let [sock (tcp-connect "localhost" 8080)]
    (tcp-send sock "hello")))

;; TEST: tcp-send bytes
;; EXPECT: 3
(with-mock-network :echo
  (let [sock (tcp-connect "localhost" 8080)]
    (tcp-send sock (bytes-from-string "abc"))))

;; Receive data
;; TEST: tcp-recv receives data
;; EXPECT: "hello"
(with-mock-network :echo
  (let [sock (tcp-connect "localhost" 8080)]
    (tcp-send sock "hello")
    (tcp-recv sock)))

;; TEST: tcp-recv with limit
;; EXPECT: 5
(with-mock-network :echo
  (let [sock (tcp-connect "localhost" 8080)]
    (tcp-send sock "hello world")
    (str-len (tcp-recv sock :max-bytes 5))))

;; TEST: tcp-recv-line
;; EXPECT: "line1"
(with-mock-network :lines
  (let [sock (tcp-connect "localhost" 8080)]
    (tcp-send sock "line1\nline2\n")
    (tcp-recv-line sock)))

;; TEST: tcp-recv timeout
;; EXPECT: nil
(with-mock-network :slow
  (let [sock (tcp-connect "localhost" 8080)]
    (tcp-recv sock :timeout 10)))

;; Bidirectional communication
;; TEST: request response
;; EXPECT: "HELLO"
(with-mock-network :upper-echo
  (let [sock (tcp-connect "localhost" 8080)]
    (tcp-send sock "hello")
    (tcp-recv sock)))

;; TEST: multiple sends
;; EXPECT: "abc"
(with-mock-network :echo
  (let [sock (tcp-connect "localhost" 8080)]
    (tcp-send sock "a")
    (tcp-send sock "b")
    (tcp-send sock "c")
    (tcp-recv sock)))

;; TEST: recv on closed socket
;; EXPECT: nil
(with-mock-network
  (let [sock (tcp-connect "localhost" 8080)]
    (socket-close sock)
    (tcp-recv sock)))
