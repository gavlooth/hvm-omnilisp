;; test_macroexpand_all.lisp - Tests for recursive macro expansion

;; Define nested macros
(define-syntax inc
  (syntax-rules ()
    ((inc x) (+ x 1))))

(define-syntax double
  (syntax-rules ()
    ((double x) (* x 2))))

(define-syntax inc-and-double
  (syntax-rules ()
    ((inc-and-double x) (double (inc x)))))

;; TEST: macroexpand-all fully expands
;; EXPECT: (* (+ x 1) 2)
(macroexpand-all '(inc-and-double x))

;; TEST: macroexpand-all nested
;; EXPECT: (* (* x 2) 2)
(macroexpand-all '(double (double x)))

;; TEST: macroexpand-all in body
;; EXPECT: (let [x 5] (* (+ x 1) 2))
(macroexpand-all '(let [x 5] (inc-and-double x)))

;; Triple nesting
(define-syntax triple-inc
  (syntax-rules ()
    ((triple-inc x) (inc (inc (inc x))))))

;; TEST: deeply nested expansion
;; EXPECT: (+ (+ (+ x 1) 1) 1)
(macroexpand-all '(triple-inc x))

;; Expansion in function body
;; TEST: expand in define
;; EXPECT: (define foo [x] (* x 2))
(macroexpand-all '(define foo [x] (double x)))

;; Expansion in conditionals
;; TEST: expand in if
;; EXPECT: (if true (+ x 1) (* x 2))
(macroexpand-all '(if true (inc x) (double x)))

;; Expansion preserves structure
;; TEST: expand complex form
;; EXPECT: (do (+ a 1) (+ b 1) (* c 2))
(macroexpand-all '(do (inc a) (inc b) (double c)))

;; TEST: macroexpand-all on non-macro
;; EXPECT: (+ 1 2)
(macroexpand-all '(+ 1 2))

;; TEST: macroexpand-all literal
;; EXPECT: 42
(macroexpand-all 42)
