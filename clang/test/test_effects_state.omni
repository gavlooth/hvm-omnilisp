;; test_effects_state.lisp - Tests for State effect (get/put)

;; State effect provides mutable state within a handler scope
;; Operations: Get (read state), Put (write state)

;; TEST: get initial state
;; EXPECT: 0
(handle
  (perform Get nil)
  (Get [_ resume] (resume 0)))

;; TEST: put and get
;; EXPECT: 42
(handle
  (do
    (perform Put 42)
    (perform Get nil))
  (Get [_ resume] (resume 42))
  (Put [v resume] (resume nil)))

;; TEST: multiple get calls
;; EXPECT: 20
(handle
  (+ (perform Get nil) (perform Get nil))
  (Get [_ resume] (resume 10))
  (Put [v resume] (resume nil)))

;; TEST: get in let
;; EXPECT: 100
(handle
  (let [x (perform Get nil)]
    (* x x))
  (Get [_ resume] (resume 10)))

;; Increment effect using state
;; TEST: increment effect
;; EXPECT: 10
(handle
  (do
    (perform Increment nil)
    (perform Increment nil)
    (perform Increment nil)
    (perform Increment nil)
    (perform Increment nil)
    (perform Get nil))
  (Increment [_ resume] (resume nil))
  (Get [_ resume] (resume 10)))

;; TEST: state with conditional - numeric
;; EXPECT: 1
(handle
  (let [x (perform Get nil)]
    (if (= (% x 2) 0) 1 0))
  (Get [_ resume] (resume 42)))
