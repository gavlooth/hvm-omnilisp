;; test_http_post.lisp - Tests for HTTP POST requests

;; HTTP POST request
;; TEST: http-post returns response
;; EXPECT: true
(with-mock-http
  (response? (http-post "http://example.com" "")))

;; TEST: http-post with body
;; EXPECT: 201
(with-mock-http :status 201
  (response-status
    (http-post "http://example.com" "data")))

;; TEST: http-post json body
;; EXPECT: 200
(with-mock-http :echo-body
  (response-status
    (http-post "http://example.com"
               (json-stringify #{"name" "test"})
               :headers #{"Content-Type" "application/json"})))

;; TEST: http-post form data
;; EXPECT: 200
(with-mock-http
  (response-status
    (http-post "http://example.com"
               "name=test&value=123"
               :headers #{"Content-Type" "application/x-www-form-urlencoded"})))

;; TEST: http-post response body
;; EXPECT: #{"id" 1 "name" "test"}
(with-mock-http :body "{\"id\": 1, \"name\": \"test\"}"
  (json-parse
    (response-body
      (http-post "http://example.com"
                 (json-stringify #{"name" "test"})))))

;; Other HTTP methods
;; TEST: http-put
;; EXPECT: 200
(with-mock-http
  (response-status
    (http-put "http://example.com/item/1" "updated")))

;; TEST: http-delete
;; EXPECT: 204
(with-mock-http :status 204
  (response-status
    (http-delete "http://example.com/item/1")))

;; TEST: http-patch
;; EXPECT: 200
(with-mock-http
  (response-status
    (http-patch "http://example.com/item/1"
                (json-stringify #{"field" "value"}))))

;; Error handling
;; TEST: http-post server error
;; EXPECT: 500
(with-mock-http :status 500
  (response-status
    (http-post "http://example.com" "data")))

;; TEST: http-post network error
;; EXPECT: "network error"
(with-mock-http :disconnect
  (handle
    (http-post "http://example.com" "data")
    (NetworkError [_ resume] "network error")))
