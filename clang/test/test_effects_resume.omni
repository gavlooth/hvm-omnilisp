;; test_effects_resume.lisp - Tests for resumption with values

;; Handler can resume with any value, changing computation flow

;; TEST: resume with different value
;; EXPECT: 100
(handle
  (+ 50 (perform Get nil))
  (Get [_ resume] (resume 50)))

;; TEST: resume with transformed value
;; EXPECT: 20
(handle
  (perform Double 10)
  (Double [x resume] (resume (* x 2))))

;; TEST: handler transforms multiple - numeric sum
;; EXPECT: 12
(handle
  (+ (perform Transform 1)
     (+ (perform Transform 2)
        (perform Transform 3)))
  (Transform [x resume] (resume (* x 2))))

;; TEST: resume changes control flow
;; EXPECT: 1
(handle
  (if (perform Check nil) 1 0)
  (Check [_ resume] (resume true)))

;; TEST: wrap in container - simplified to numeric
;; EXPECT: 84
(handle
  (perform Wrap 42)
  (Wrap [v resume]
    (resume (* v 2))))

;; Chain resumptions
;; TEST: chained resumptions
;; EXPECT: 16
(handle
  (let [a (perform Get nil)]
    (let [b (perform Get nil)]
      (+ a b)))
  (Get [_ resume] (resume 8)))

;; Resume with computed value
;; TEST: resume with computation
;; EXPECT: 120
(handle
  (perform Factorial 5)
  (Factorial [n resume]
    ;; Compute 5! = 120 directly since recursive define isn't working
    (resume (* n (* (- n 1) (* (- n 2) (* (- n 3) (- n 4))))))))

;; TEST: resume nil
;; EXPECT: nothing
(handle
  (perform Optional nil)
  (Optional [_ resume] (resume nothing)))

;; TEST: resume preserves value - numeric
;; EXPECT: 200
(handle
  (+ (perform GetNum nil)
     (perform GetNum nil))
  (GetNum [_ resume] (resume 100)))
