;; test_effects_compose.omni - Tests for effect handler composition

;; State + Reader composition - numeric
;; TEST: combine state and reader
;; EXPECT: 200
(handle
  (handle
    (* 2 (perform ask nil))
    (ask [_ resume] (resume (perform get-env nil))))
  (get-env [_ resume] (resume 100)))

;; Reader + Writer composition - numeric
;; TEST: read config and log
;; EXPECT: 999
(handle
  (handle
    (do
      (perform tell (perform ask-val nil))
      999)
    (ask-val [_ resume] (resume 50)))
  (tell [msg resume] (resume msg)))

;; State + Exception composition - numeric
;; TEST: state with error handling
;; EXPECT: 105
(handle
  (handle
    (do
      (perform put-state 5)
      (+ 100 (perform get-state nil)))
    (raise-err [_ resume] (resume 0)))
  (get-state [_ resume] (resume 5))
  (put-state [v resume] (resume v)))

;; All three: Reader + Writer + Exception - numeric
;; TEST: three effects composed
;; EXPECT: 42
(handle
  (handle
    (handle
      (let [config (perform ask-cfg nil)]
        (do
          (perform log config)
          (if (= config 0)
            (perform raise 0)
            config)))
      (ask-cfg [_ resume] (resume 42)))
    (log [msg resume] (resume msg)))
  (raise [msg resume] (resume 0)))

;; Effect delegation pattern - numeric
;; TEST: delegate to outer handler
;; EXPECT: 200
(handle
  (handle
    (perform forward 100)
    (forward [msg resume]
      (perform outer-handle msg)))
  (outer-handle [msg resume]
    (resume (* msg 2))))

;; EXPECT: true
(= (handle
     (handle
       (perform process 10)
       (process [msg resume]
         (perform output (* msg msg))))
     (output [msg resume] (resume msg)))
   100)
