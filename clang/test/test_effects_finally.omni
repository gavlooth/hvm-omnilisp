;; test_effects_finally.omni - Tests for effect cleanup patterns

;; Cleanup pattern using handle with early return
;; TEST: handle returns result - numeric
;; EXPECT: 42
(handle
  42
  (cleanup [msg resume] (resume msg)))

;; TEST: cleanup after effect - numeric
;; EXPECT: 999
(handle
  (do
    (perform cleanup-needed 1)
    999)
  (cleanup-needed [msg resume] (resume 999)))

;; TEST: nested handles for cleanup
;; EXPECT: 42
(handle
  (handle
    42
    (inner [msg resume] (resume msg)))
  (outer [msg resume] (resume msg)))

;; TEST: finally-like pattern - return cleanup status - numeric
;; EXPECT: 100
(handle
  (let [result (perform work 1)]
    result)
  (work [task resume] (resume 100)))

;; TEST: multiple cleanup operations
;; EXPECT: true
(handle
  (do
    (perform step1 1)
    (perform step2 2)
    true)
  (step1 [msg resume] (resume msg))
  (step2 [msg resume] (resume msg)))

;; TEST: effect with resumption and cleanup value
;; EXPECT: 42
(handle
  (+ (perform get-value 1) 2)
  (get-value [key resume] (resume 40)))

;; TEST: with-resource pattern
;; EXPECT: 100
(do
  (define with-resource [init] [body]
    (handle
      (let [r init]
        (let [result (body r)]
          (do
            (perform release r)
            result)))
      (release [r resume] (resume nothing))))
  (with-resource 10 (lambda [r] (* r 10))))

;; EXPECT: true
(handle
  (do
    (perform setup nothing)
    (perform teardown nothing)
    true)
  (setup [_ resume] (resume nothing))
  (teardown [_ resume] (resume nothing)))
