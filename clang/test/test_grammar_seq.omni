;; test_grammar_seq.lisp - Tests for sequence combinator

;; Seq matches rules in order
;; TEST: sequence of literals
;; EXPECT: ("hello" " " "world")
(defgrammar hello-world
  (seq (lit "hello") (lit " ") (lit "world")))
(parse hello-world "hello world")

;; TEST: sequence of char classes
;; EXPECT: ("a" "1")
(defgrammar letter-digit
  (seq (char-range "a" "z") (char-range "0" "9")))
(parse letter-digit "a1")

;; TEST: sequence fail first
;; EXPECT: nil
(parse letter-digit "11")

;; TEST: sequence fail second
;; EXPECT: nil
(parse letter-digit "ab")

;; TEST: long sequence
;; EXPECT: ("a" "b" "c" "d")
(defgrammar abcd
  (seq (lit "a") (lit "b") (lit "c") (lit "d")))
(parse abcd "abcd")

;; Sequence with optional
;; TEST: sequence with optional present
;; EXPECT: ("hello" " " "world")
(defgrammar opt-hello
  (seq (lit "hello") (optional (lit " ")) (lit "world")))
(parse opt-hello "hello world")

;; TEST: sequence with optional absent
;; EXPECT: ("hello" nil "world")
(parse opt-hello "helloworld")

;; Sequence flattening
;; TEST: nested sequence
;; EXPECT: (("a" "b") ("c" "d"))
(defgrammar nested-seq
  (seq (seq (lit "a") (lit "b"))
       (seq (lit "c") (lit "d"))))
(parse nested-seq "abcd")

;; TEST: sequence with repetition
;; EXPECT: ("x" ("1" "2" "3"))
(defgrammar x-digits
  (seq (lit "x") (one-or-more (char-range "0" "9"))))
(parse x-digits "x123")
